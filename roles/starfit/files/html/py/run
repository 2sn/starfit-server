#!/usr/bin/env python
print("Content-Type: text/html; charset=UTF-8\n")

import cgi
import cgitb
import time

from redis import Redis
from rq import Queue

cgitb.enable()

from job import render, run_job
from utils import Config

forms = cgi.FieldStorage()  # Retrieve form fields
config = Config(forms)  # Validate form fields and generate config

if len(config.errors) > 0:
    # Render the error page
    page = render(config=config, result=None, img_tags=[], doc="webpage")
else:
    # Start job in background
    q = Queue(connection=Redis(), default_timeout=3600)
    j = q.enqueue(run_job, config)
    if not config.mail:  # Wait for job to complete if not sending an email
        while j.get_status() in ("queued", "started", "scheduled", "deferred"):
            time.sleep(1)
        if j.get_status() == "finished":
            page = j.result
        else:  # TODO: convert into a user friendly error
            print(j.get_status(), j.exc_info)
            raise RuntimeError(j.exc_info)
    else:  # Render the 'sending email' page
        page = render(config=config, result=None, img_tags=[], doc="webpage")

# Display page
print(page)
