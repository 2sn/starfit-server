#!/usr/bin/env python
print("Content-Type: text/html; charset=UTF-8\n")

import cgi
import cgitb
import sys
from datetime import datetime

cgitb.enable()

from job import compute_and_render, send_email
from utils import Config

start_time = datetime.now().strftime("%Y-%M-%d-%H-%M-%S")

# Retrieve form fields and validate
c = Config(cgi.FieldStorage(), start_time)

page, body, imgfiles = compute_and_render(c, start_time)

print(page)

if len(c.errors) > 0:
    sys.exit()

if c.mail:
    send_email(c, body, imgfiles, start_time)
